<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
		<title>Datacube Test</title>
		<style>
			@import url('https://fonts.googleapis.com/css?family=Fira+Sans|Roboto+Slab&display=swap');

			body {
				font-family: 'Roboto', Arial, Helvetica, sans-serif;
				font-weight: normal;
				font-style: normal;
				font-size: 12px;
			}

			table {
				border-collapse: collapse;
			}

			td {
				/* border:1px solid gray; */
				padding:0;
			}

			* {box-sizing: border-box;}

			button {
				font-family: inherit;
			}

			input {
				font-family: inherit;
				font-size: 16px;
				font-style: inherit;
				font-weight: inherit;
				background-color: transparent;
				color: #263238;
				border-left-color: transparent;
				border-top-color: transparent;
				border-right-color: transparent;
				outline-style: none;
				width: 100px;
			}

			body.new-school{
				font-family:'Fira Sans', sans-serif;
				color: #545759;
				background:#ABACA5;
				/* font-size: 14px; */
			}

			.new-school h3{
				font-family:'Roboto Slab', serif;
				color:#E03C31;
			}

			#debugtools {
				background:#a0a0a0;
			}

			.new-school #debugtools {
				background:#DDE4E6;
				border:3px solid #545759;
				box-sizing: border-box;
				/* background:white; */
			}

			.relative {
				position:relative;
				top:0px;
				left:0px;
				transform: translate(0, 0);
			}

			.selected-payment-display {
				width:220px;
			}

			.verticalbuttons {
				width:20px;
				position:relative;
			}

			.horizontalbuttons {
				height:20px;
				position:relative;
			}

			.verticalbuttons button,
			.horizontalbuttons button{
				border:0;
				border-radius:5px;
				font-weight: bold;
				font-size:15px;
			}
			.horizontalbuttons button{height:100%;}
			.verticalbuttons button{width:100%;}

			.shaded {
				background-color: rgba(250, 250, 250, 1);
				padding-left: 10px;
				padding-right: 10px;
			}

			.locator.active {
				display:inline-block;
				margin:2px;
				width:7px;
				height:7px;
				font-size:0px;
				background:#64b5f6;
				border:0;
			}

			.locator {
				display:inline-block;
				margin:2px;
				width:7px;
				height:7px;
				font-size:0px;
				background:#808080;
				border:2px solid transparent;
			}
			#horizontal-locator {
				position:absolute;
				padding-top:5px;
				top:0px;
				left:0px;
				height:100%;
				width:100%;
				text-align:center;
				pointer-events: none;
			}
			#vertical-locator {
				position:absolute;
				top:50%;
				left:50%;
				transform:translate(-50%, -50%);
				width:10px;
				text-align:center;
				pointer-events: none;
			}
			.depth-locator {
				position:absolute;
				width:100px;
				height:100px;
				text-align:center;
				pointer-events: none;
			}
			.payment-pane .locator.active {
				background:#64b5f6;
				opacity: 1;
			}
			.depth-locator .locator {
				display:block;
				position: absolute;
				width:20px;
				height:20px;
				margin:0px;
				background:#a0a0a0;
				border:1px solid black;
				opacity: 0.9;
				transform:translate(-50%, -50%);
			}

			.new-school .payment-pane .locator.active{
				background:#26407A;
			}

			.inputTextRight {
				text-align: right;
				border-bottom-color: black;
			}

			.inputTextCenter {
				text-align: center;
				border-bottom-color: black;
			}

			.cube td,
			.paymentTextBox {
				background-color: rgba(255, 255, 255, 1);
				-moz-box-shadow: none;
				-webkit-box-shadow: none;
				box-shadow: none;
				color: rgba(38, 50, 56, 1);
				text-align: center;
			}

			.inputROTextRight {
				text-align: right;
				border-bottom-color: transparent;
			}

			.scene {
				width: 300px;
				height: 300px;
				perspective: 1000px;
				/* perspective: 300px; */
				background:black;
				border-bottom:1px solid black;
				border-right:1px solid black;
				border-left:1px solid gray;
				position:relative;
				top:0px;
				left:0px;
				overflow:hidden;
			}
			.new-school .scene {
				background:#545759;
				border-bottom:1px solid black;
				border-right:1px solid black;
				border-left:1px solid gray;
			}

			.new-school .payment-pane {
				background:#DDE4E6;
				border-radius: 10px;;
			}
			#payments {
				position:absolute;
				top:50%;
				left:50%;
				/* transform: translate(-50%, -50%); */
				transform: translateX(-50%) translateY(calc(-50% - .5px));
				margin-top:-1px;
			}

			.payment-pane button{
				font-family: 'Roboto', Arial, Helvetica, sans-serif;
			}

			.new-school .payment-pane button{
				color:white;
				background:#E03C31;
				font-weight: bold;
				border:none;
				border-radius:5px;
			}


			.payments td {
				width:100px;
				height:100px;
				/* border: 1px solid rgba(38, 50, 56, 1); */
				border: 1px solid black;
				margin: 0;
				border-spacing:0;
				border-collapse: collapse;
			}

			.cube {
				width: 100%;
				height: 100%;
				transform: translateZ(-150px);
				position: relative;
				top:0;
				left:0;
				transform-style: preserve-3d;
				transition: transform 0.5s;
			}
			.cube.free-rotation {
				/* transition: transform 0.1s; */
				transition-property: none;
			}


			.grid-x,
			.label-top{
				position:relative;
				top:0px;
				left:0px;
				min-height:3em;
				overflow:hidden;
			}
			.label-top{
				pointer-events: none;
			}
			.label-left {
				pointer-events: none;
				top:0px;
				left:0px;
				height:100%;
				overflow:hidden;
			}

			.new-school .label-left,
			.new-school .label-top,
			.new-school .depth-value {
				color:#E03C31;
				font-family:'Roboto Slap', serif;
				font-size:14px;
			}

			.grid-y {
				position:absolute;
				top:0px;
				left:0px;
				height:300px;
				width:100%;
				overflow:hidden;
				border-bottom: 1px solid black;
			}

			.grid-x>*,
			.grid-y>*,
			.label-top>*,
			.label-left>* {
				transition: opacity 0.5s, top 0.5s, transform 0.5s;
				position:absolute;
				top:0px;
				left:0px;
				width:100%;
				height:100%;
				text-align: center;
			}

			.show-front .cube  { transform: translateZ(-150px) rotateY(   0deg); }
			.show-left .cube  { transform: translateZ(-150px) rotateY( 90deg); }
			.show-right .cube  { transform: translateZ(-150px) rotateY( -90deg); }
			.show-top .cube    { transform: translateZ(-150px) rotateX( -90deg); }

			.show-top .cube__face.top,
			.show-top .cube__face.right {
				display:none;
			}

			.show-top .grid-x .pmt-mileage,
			.show-front .grid-x .pmt-mileage,
			.show-right .grid-x .pmt-cashdown,
			.show-top .grid-y .pmt-term,
			.show-front .grid-y .pmt-mileage,
			.show-right .grid-y .pmt-mileage,
			.show-top .label-left .pmt-term,
			.show-front .label-left .pmt-mileage,
			.show-right .label-left .pmt-mileage {
				transition:left 0.25s;
				opacity:0;
			}


			.show-bottom .label-top .pmt-mileage,
			.show-top .label-top .pmt-mileage,
			.show-front .label-top .pmt-mileage {
				opacity:0.5;
				transition:left 0.25s;
				left:25%;
			}

			.show-front .label-left .pmt-mileage,
			.show-left .label-left .pmt-mileage,
			.show-right .label-left .pmt-mileage {
				opacity:0.5;
				transition:top 0.25s;
				top:50%;
			}

			.show-bottom .label-left .pmt-term,
			.show-top .label-left .pmt-term {
				opacity:0.5;
				transition:top 0.25s;
				top:50%;
			}

			.show-left .label-top .pmt-cashdown,
			.show-right .label-top .pmt-cashdown{
				opacity:0.5;
				transition:left 0.25s;
				left:-25%;
			}

			.grid-y table,
			.label-left table {
				height:100%;
			}

			.grid-x table,
			.grid-y table,
			.label-left table,
			.grid-x input {
				width:100%;
			}

			.grid-x table,
			.grid-y table,
			.label-top table {
				width:100%;
				table-layout: fixed;
			}

			.grid-x table tr,
			.grid-y table tr,
			.label-top table tr {
				min-height:1.2em;
			}
			.grid-x table td,
			.grid-y table td,
			.label-top table td {
				width:100px;
			}

			.grid-x>div{
				transition:left 0.25s;
			}

			.show-top .grid-x .pmt-cashdown,
			.show-front .grid-x .pmt-cashdown,
			.show-right .grid-x .pmt-mileage,
			.show-top .label-top .pmt-cashdown,
			.show-front .label-top .pmt-cashdown,
			.show-right .label-top .pmt-mileage,
			.show-top .label-left .pmt-mileage,
			.show-front .label-left .pmt-term,
			.show-right .label-left .pmt-term,
			.show-top .grid-y .pmt-mileage,
			.show-front .grid-y .pmt-term,
			.show-right .grid-y .pmt-term {
				opacity:1;
			}

			.cube__face {
				position: absolute;
				left:0px;
				top:0px;
				width: 100%;
				height: 100%;
				color:black;
				text-align: center;
				backface-visibility:hidden;
				transform-origin: center center;
			}
			.cube__face.front  { transition: opacity 0.5s; width:100px;}
			.cube__face.right  { transition: opacity 0.5s;}
			.cube__face.top    { transition: opacity 0.5s; width:100px;}

			.payments {
				width:100%;
				height:100%;
				table-layout: fixed;
				border-collapse: collapse;
			}

			.payments input{
				width:100%;
			}

			.selectedPayment {
				background-color: rgba(100, 181, 246, 1) !important;
				color: #ffffff !important;
			}

			.depth-value {
				text-align:center;
				height:1.5em;
				line-height: 1.5em;
			}

			.payments td.hidden {
				opacity:0;
				border-color:transparent;
			}

			.button-up,
			.button-left {
				position: absolute;
				left:0px;
				top:0px;
			}
			.button-right {
				position: absolute;
				right:0px;
				top:0px;
			}
			.button-down {
				position: absolute;
				right:0px;
				bottom:0px;
			}
		</style>
		<script>
			class PaymentCube{
				constructor(element, x, y, z, scale) {
					this.size = {
						c: x,
						t: y,
						m: z
					};
					this.element = element;
					this.scale = scale || 100;
					this.element.attr("x", x).attr("y", y).attr("z", z);
					this.createPaymentCubeSide('front', x, y, z);
					this.createPaymentCubeSide('right', z, y, x);
					this.createPaymentCubeSide('top', x, z, y);
					this.createPaymentCubeSide('left', z, y, x);
					this.createPaymentCubeSide('bottom', x, z, y);
				}
				createPaymentCell(c, i, coord) {
					return $("<td class=\"" + c + i + "\" cube-cash=\"" + coord.c + "\" cube-term=\"" + coord.t + "\" cube-mileage=\"" + coord.m + "\"><input type=\"text\" class=\"inputROTextRight pmt\" readonly=\"readonly\" tabindex=\"-1\" value=\"0.00\"></td>");
				}
				createPaymentCubeSide(side, x, y, z) {
					var rowClass = "t", colClass = "c", depthClass = "m", depthIndex=1;
					var translateZ = ((z-3) * 100) + 150;
					var translateY = 0;
					var transform;
					var coordinates = {
						c: x,
						t: y,
						m: z
					}
					if (side == "right" || side=="left") {
						colClass="m";
						depthClass="c";
						coordinates.c = z;
						coordinates.m = x;
					}
					else if (side == "top") {
						rowClass="m";
						depthClass="t";
						translateY = ((this.offset.m+1.5-y) * 100);
						coordinates.t = z;
						coordinates.m = y;
					}
					else if (side == "bottom") {
						rowClass="m";
						depthClass="t";
						// translateY = ((3-y) * 100);
						translateY = ((this.offset.m+1.5-y) * 100);
						coordinates.t = z;
						coordinates.m = y;
					}


					for (let h = 0; h < z; h++) {
						var sideElement, sideTable;


						// // Working version as of 11/13/2019
						// if (side == "front") {
						// 	depthIndex = h+1;
						// 	coordinates.m = h;
						// 	translateZ = (this.offset.m-h) * this.scale;
						// 	transform =  "rotateY(0deg) translateZ(" + translateZ + "px) translateX(" + ((x-3)/2 * -100) + "px)";
						// }
						// else if (side == "right") {
						// 	depthIndex = z-h;
						// 	coordinates.c = depthIndex-1;
						// 	translateZ = (this.offset.c+0.5-h) * this.scale;
						// 	transform =  "rotateY(90deg) translateZ(" + translateZ + "px) translateX(" + ((this.offset.m-1.5) * -100) + "px)";
						// }
						// else if (side == "top") {
						// 	depthIndex = h+1;
						// 	coordinates.t = h;
						// 	translateZ = (1.5-h) * this.scale;
						// 	transform = "rotateX(90deg) translateZ(" + translateZ + "px) translateY(" + translateY + "px) translateX(" + ((x-3)/2 * -100) + "px)";
						// }
						// else if (side == "left") {
						// 	depthIndex = h+1;
						// 	coordinates.c = h;
						// 	translateZ = (this.offset.c+0.5-h) * this.scale;
						// 	transform = "rotateY(-90deg) translateZ(" + translateZ + "px) translateX(" + (((this.offset.m-x+1.5)*100)) + "px)";
						// }
						// // End Working Version


						//Test version, 11/13/2019
						if (side == "front") {
							depthIndex = h+1;
							coordinates.m = h;
							translateZ = ((h)-((this.size.m)/2)) * -100;
							// transform =  "rotateY(0deg) translateZ(" + translateZ + "px) translateX(" + ((this.size.c-3) * (-this.scale/2)) + "px)";
							transform =  "rotateY(0deg) translateZ(" + translateZ + "px)";
						}
						else if (side == "right") {
							depthIndex = z-h;
							coordinates.c = depthIndex-1;
							var mod = (this.size.m - this.size.c)/2;
							translateZ = (((this.size.c)/2)-h-mod) * this.scale;
							transform =  "rotateY(90deg) translateZ(" + translateZ + "px)";
						}
						else if (side == "top") {
							depthIndex = h+1;
							coordinates.t = h;
							var mod = (this.size.t - this.size.m)/2;
							// translateZ = ((h)-((this.size.t+1)/2)) * -100;
							translateZ = (((this.size.t)/2)-h-mod) * this.scale;
							transform = "rotateX(90deg) translateZ(" + translateZ + "px)";
						}
						else if (side == "left") {
							depthIndex = h+1;
							coordinates.c = h;
							// translateZ = ((h)-((this.size.c+1)/2)) * -100;
							var mod = (this.size.m - this.size.c)/2;
							translateZ = (mod+((this.size.c)/2)-h) * this.scale;
							transform = "rotateY(-90deg) translateZ(" + translateZ + "px)";
						}
						else if (side == "bottom") {
							depthIndex = z-h;
							coordinates.t = depthIndex-1;
							// translateZ = ((h)-((this.size.t-1)/2)) * -100;
							var mod = (this.size.t - this.size.m)/2;
							translateZ = (mod+((this.size.t)/2)-h) * this.scale;
							transform = "rotateX(-90deg) translateZ(" + translateZ + "px)";
						}
						//End Test Version


						sideTable = $("<table class=\"payments\"></table>");
						for (let i = 0; i < y; i++) {
							var sideRow = $("<tr class=\"" + rowClass + (i + 1) + "\"></tr>");
							for (let j = 0; j < x; j++) {

								if (side == "front") {
									coordinates.c = j;
									coordinates.t = i;
								} else if (side == "right") {
									coordinates.t = i;
									coordinates.m = j;
								} else if (side == "top") {
									coordinates.c = j;
									coordinates.m = y-1-i;
								} else if (side == "bottom") {
									coordinates.c = j;
									coordinates.m = i;
								} else if (side == "left") {
									coordinates.t = i;
									coordinates.m = x-1-j;
								}

								sideRow.append(this.createPaymentCell(colClass, j + 1, coordinates));
							}
							sideTable.append(sideRow);
						}
						sideElement = $("<div class=\"cube__face " + side + " " + depthClass + (depthIndex) + "\" translate-y=\"" + translateY + "\" translate-z=\"" + translateZ + "\"></div>");
						sideElement.append(sideTable);
						sideElement.css("transform", transform);

						// Set size for test version
					 	sideElement.css("width", (x * this.scale) + "px");
					 	sideElement.css("height", (y * this.scale) + "px");

						this.element.append(sideElement);
					}
				}
				getCubeSize(mod){
					mod = mod || 0;
					var cs = {
						c:(this.size.c + mod),
						t:(this.size.t + mod),
						m:(this.size.m + mod)
					};
					return cs;
				}
				hideCells(side, index) {
					$(".payments td").show();
					$(".hidden").removeClass("hidden");
					switch (side) {
						case "front":
							$("div.right").hide();
							$("div.right.c" + (this.size.c)).show();
							$("div.left").hide();
							$("div.left.c1").show();
							$("div.top").hide();
							$("div.bottom").hide();
							$("div.top.t1").show();

							// for (let i = 0; i < index; i++) {
							// 	$(".right").find("td[cube-mileage=\"" + i + "\"]").addClass("hidden");
							// 	$(".top").find("td[cube-mileage=\"" + i + "\"]").addClass("hidden");
							// }

							$("div.front").hide();
							$("div.m" + (index+1)).show();
							break;
						case "right":
							$("div.front").hide();
							$("div.left").hide();
							$("div.left.c1").show();
							$("div.top").hide();
							$("div.bottom").hide();
							$("div.top.t1").show();
							$("div.m1").show();

							// for (let i = index+1; i < this.size.c; i++) {
							// 	$(".front").find("td[cube-cash=\"" + i + "\"]").addClass("hidden");
							// 	$(".top").find("td[cube-cash=\"" + i + "\"]").addClass("hidden");
							// }
							break;
						case "top":
							$("div.front").hide();
							$("div.m1").show();
							$("div.left").hide();
							$("div.left.c1").show();
							$("div.right").hide();
							$("div.right.c" + (this.size.c)).show();

							$("div.top").hide();
							$("div.bottom").hide();
							$("div.t" + (index+1)).show();


							// for (let i = 0; i < index; i++) {
							// 	$("tr.t" + (i+1) + " td").addClass("hidden");
							// }
							break;

						default:
							break;
					}
				}
				get offset() {
					return {
						c: ((this.size.c-1)/2),
						t: ((this.size.t-1)/2),
						m: ((this.size.m-1)/2)
					}
					// return { c: 0, t: 0, m: 0 };
				}
				update(x, y, z, rotX, rotY) {
					rotX = rotX || 0;
					rotY = rotY || 0;
					var tx = " translateX(";
					var ty = " translateY(";
					var tz = " translateZ(";
					var rs = " rotateX(" + rotX + "deg) rotateY(" + rotY + "deg)";

					tx += (-x*this.scale) + "px)";
					ty += (-y*this.scale) + "px)";
					tz += (-z) + "px)";
					this.element.css("transform", tz + ty + tx + rs);
				}
			}

			class PaymentCubePane {
				constructor(element, x, y, z) {
					this.viewStates = {
						Custom:0,
						FreeRotation:1,
						AllShown:2
					}
					this._viewState = 0;
					this.element = element;
					this.element.append(
						$(`
						<button class="show-selected"">Move to Selected Payment</button>
						<button class="show-default">Move to default view</button>
						<table class="shaded payment-pane" style="table-layout: fixed;">
							<tr>
								<td colspan="3">
									<div class="selected-payment-display"></div>
								</td>
								<td style="width:300px;" class="relative">
									<button class="button-left rotate-left"> &larr; </button>
									<div class="label-top">
										<div class="pmt-mileage"> Mileage </div>
										<div class="pmt-cashdown"> Cash Down </div>
									</div>
									<button class="button-right rotate-right"> &rarr; </button>
								</td>
								<td></td>
							</tr>
							<tr>
								<td></td>
								<td align="center" class="relative">
									<button class="button-left rotate-down"> &larr; </button>
									<div class="label-left">
										<div class="pmt-mileage"> Mileage </div>
										<div class="pmt-term"> Term </div>
									</div>
									<button class="button-right rotate-up"> &rarr; </button>
								</td>
								<td align="center">Rate</td>
								<td>
									<div class="grid-x">
										<div class="pmt-mileage">
											<table>
												<tr></tr>
											</table>
										</div>
										<div class="pmt-cashdown">
											<table>
												<tr></tr>
											</table>
										</div>
									</div>
								</td>
								<td></td>
							</tr>
							<tr class="primary-row">
								<td class="relative verticalbuttons">
									<button class="button-up rotate-up"> &uarr; </button>
									<button class="button-down rotate-down"> &darr; </button>
								</td>
								<td style="width:100px;" class="relative">
									<div class="grid-y" style="height:100%;">
										<div class="pmt-mileage">
											<table class="payments"></table>
										</div>
										<div class="pmt-term">
											<table class="payments"></table>
										</div>
									</div>
								</td>
								<td style="width:100px;" class="relative">
									<div class="grid-y" style="height:100%;">
										<div class="pmt-rate">
											<table class="payments"></table>
										</div>
									</div>
								</td>
								<td class="relative">
									<div class="scene">
										<div class="cube"></div>
									</div>
								</td>
								<td class="relative verticalbuttons">
									<button class="button-up slide-up"> &uarr; </button>
									<div id="vertical-locator"></div>
									<button class="button-down slide-down"> &darr; </button>
								</td>
							</tr>
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td class="relative">
									<div class="horizontalbuttons">
										<button class="button-left slide-left"> &larr; </button>
										<button class="button-down zoom-out" style="left:15%;">
											&darr;
										</button>
										<div id="horizontal-locator"></div>
										<button class="zoom-in" style="position: absolute; top:0; right:15%;">
											&uarr;
										</button>
										<button class="button-right slide-right"> &rarr; </button>
									</div>
								</td>
								<td class="relative">
									<div class="depth-locator"></div>
								</td>
							</tr>
							<tr>
								<td colspan="3"</td>
								<td colspan="3" class="depth-value">
									<span class="label"></span>
									<span class="value"></span>
								</td>
							</tr>
						</table>
						`)
					);
					this.scale = 100;
					this.cube = new PaymentCube(this.$(".cube"), x, y, z, this.scale);
					this._side = "front";
					this.rotation = {
						X: 0,
						Y: 0
					};
					this.snapRotation = {
						X: 0,
						Y: 0
					};
					this.size = {
						c: x,
						t: y,
						m: z
					};
					this.selectedPayment = {
						c: -1,
						t: -1,
						m: -1
					};
					this._slide = {
						c: 0,
						t: 0,
						m: 0
					};
					var self = this;
					this.element.on("click", ".slide-up", function() {self.slide('y', -1)});
					this.element.on("click", ".slide-down", function() {self.slide('y', 1)});
					this.element.on("click", ".slide-left", function() {self.slide('x', -1)});
					this.element.on("click", ".slide-right", function() {self.slide('x', 1)});
					this.element.on("click", ".zoom-out", function() {self.zoom('out')});
					this.element.on("click", ".zoom-in", function() {self.zoom('in')});

					this.element.on("click", ".rotate-up", function() {self.side="top"});
					this.element.on("click", ".rotate-down", function() {self.side="front"});
					this.element.on("click", ".rotate-left", function() {self.side="front"});
					this.element.on("click", ".rotate-right", function() {self.side="right"});

					this.element.on("click", ".show-default", function() {self.showSpecificPayment(0, 0, 0, "front")});
					this.element.on("click", ".show-selected", function() {self.showSelectedPayment()});
					this.element.on("click", ".payments td", function() {self.selectPayment(this)});

					this.createLocators(x, y, z);

					for (let i = 0; i < x; i++) {
						this.$(".pmt-cashdown tr").append($(`<td><input type="text" id="txtCashDownC${i}" class="inputTextRight cashdownC${i}" /></td>`));
					}
					for (let i = 0; i < z; i++) {
						this.$(".grid-x .pmt-mileage tr").append($(`<td><input type="text" id="txtMileageM${i}" class="inputTextRight mileageM${i}" /></td>`));
						this.$(".grid-y .pmt-mileage table").append($(`<tr><td><input type="text" id="txtMileageM${i}" class="inputTextRight mileageM${i}" /></td></tr>`));
					}
					for (let i = 0; i < y; i++) {
						this.$(".grid-y .pmt-term table").append($(`<tr><td><input type="text" id="txtTermR${i}" class="inputTextCenter termR${i}" /></td></tr>`));
					}
					for (let i = 0; i < y; i++) {
						this.$(".grid-y .pmt-rate table").append($(`<tr><td><input type="text" id="txtRateR${i}" class="inputTextRight rateR${i} notermR${i}" /></td></tr>`));
					}
					this.rotationMod = {
						x: (3 - this.size.c) * this.scale/2,
						z: (Math.max(this.size.c, Math.max(this.size.t, this.size.m)) * -this.scale)
					};
				}
				$(toFind) {
					return this.element.find(toFind);
				}
				createLocators(x, y, z) {
					for (let i = 0; i < x; i++) {
						$("#horizontal-locator").append($("<span class=\"locator\"></span>"));
					}
					for (let i = 0; i < y; i++) {
						$("#vertical-locator").append($("<span class=\"locator\"></span>"));
					}
					for (let i = 0; i < z; i++) {
						var loc = $("<span class=\"locator\"></span>");
						loc.css("right", (i * 5) + "px");
						loc.css("bottom", 100 - (i * 8) + "px");
						this.$(".depth-locator").append(loc);
					}
				}
				get depthLabel() {
					var lbl =  $(".depth-value .label").text();
					return lbl.substr(0, lbl.indexOf(':'));
				}
				set depthLabel(value) {
					$(".depth-value .label").text(value + ": ");
				}
				freeRotation(x, y, z){
					this.viewState = this.viewStates.FreeRotation;
					this.rotation.X = x;
					this.rotation.Y = y;
					if (z == null || z == undefined || z == 0) {
						z = this.rotationMod.z;
					}
					this.cube.element.css("transform", "translateZ(" + z + "px) rotateX(" + x + "deg) rotateY(" + y + "deg) translateX(" + this.rotationMod.x + "px)");
				}
				getPaymentCell(c, t, m) {
					return this.$(".payments td[cube-cash=\"" + c + "\"][cube-term=\"" + t + "\"][cube-mileage=\"" + m + "\"]");
				}
				get max(){
					var cs = { c:0, t:0, m:0 };
					switch (this._side) {
						case "top":
							cs = { c:this.size.c-3, t:this.size.t-1, m:this.size.m-3 };
							break;
						case "right":
							cs = { c:this.size.c-1, t:this.size.t-3, m:this.size.m-3 };
							break;

						default:
							cs = { c:this.size.c-3, t:this.size.t-3, m:this.size.m-1 };
							break;
					}
					return cs;
				}
				get offset() {
					return {
						c: ((this.size.c)/2),
						t: ((this.size.t)/2),
						m: ((this.size.m)/2)
					}
					// return { c: 0, t: 0, m: 0 };
				}
				populateHeaders() {
					var cd = this.$(".pmt-cashdown input");
					var m = this.$(".pmt-mileage input");
					var m2 = this.$(".grid-y .pmt-mileage table input");
					var t = this.$(".grid-y .pmt-term table input");
					var r = this.$(".grid-y .pmt-rate table input");
					for (let i = 0; i < Math.min(cd.length, cashDownValues.length); i++) {
						$(cd[i]).val(cashDownValues[i]);
					}
					for (let i = 0; i < Math.min(m.length, mileageValues.length); i++) {
						$(m[i]).val(mileageValues[i]);
						$(m2[i]).val(mileageValues[i]);
					}
					for (let i = 0; i < Math.min(t.length, termValues.length); i++) {
						$(t[i]).val(termValues[i]);
						$(r[i]).val(rateValues[i]);
					}
				}
				populatePayments(pmts) {
					for (let d = 0; d < this.size.m; d++) {
						const pmtZ = pmts[d];
						for (let h = 0; h < this.size.t; h++) {
							const pmtY = pmtZ[h];
							for (let w = 0; w < this.size.c; w++) {
								const pmtX = pmtY[w];
								this.getPaymentCell(w, h, d).find("input").val(pmtX+".00");
							}
						}
					}
				}
				resizeLocators() {
					var bounds = this.size;
					var x=0, y=0, z=0;
					$(".locator").remove();
					switch (this.side) {
						case 'front':
							x = bounds.c;
							y = bounds.t;
							z = bounds.m;
							break;
						case 'right':
							x = bounds.m;
							y = bounds.t;
							z = bounds.c;
							break;
						case 'top':
							x = bounds.c;
							y = bounds.m;
							z = bounds.t;
							break;
					}
					this.createLocators(x, y, z);
				}
				showSpecificPayment(c, t, m, rotation){
					var max = this.max;
					c = Math.max(c-1, 0);
					m = Math.max(m-1, 0);
					t = Math.max(t-1, 0);
					c = Math.min(c, max.c);
					m = Math.min(m, max.m);
					t = Math.min(t, max.t);
					rotation = rotation || this._side;
					this._slide.c = c;
					this._slide.t = t;
					this._slide.m = m;
					this.side=rotation;
					this.update();
				}
				showSelectedPayment() {
					if (this.selectedPayment.c > -1 && this.selectedPayment.t > -1 && this.selectedPayment.m > -1) {
						this.showSpecificPayment(this.selectedPayment.c, this.selectedPayment.t, this.selectedPayment.m);
					}
				}
				get side(){
					return this._side;
				}
				set side(side){
					this._side=side;
					var showClass = 'show-' + side;
					this.element.attr("class", showClass);
					this.resizeLocators();
					switch (this._side) {
						case "right":
							this.depthLabel = "Cash Down";
							this.snapRotation.X=0;
							this.snapRotation.Y=-90;
							break;
						case "left":
							this.depthLabel = "Cash Down";
							this.snapRotation.X=0;
							this.snapRotation.Y=90;
							break;
						case "top":
							this.depthLabel = "Term";
							this.snapRotation.X=-90;
							this.snapRotation.Y=0;
							break;
						default:
							this.depthLabel = "Mileage";
							this.snapRotation.X=0;
							this.snapRotation.Y=0;
							break;
					}
					this.slide("x", 0);
					this.slide("y", 0);
					this.slide("z", 0);
					this.update();
				}
				slide(axis, slide) {
					axis = axis || 'x';
					var ts = this._slide.t;
					var ms = this._slide.m;
					var cs = this._slide.c;
					var max = this.max;

					var x=0, y = 0, z=0;
					if (axis == 'x') {
						if (this._side == 'right') {
							ms += slide;
							ms = Math.min(Math.max(ms, 0), max.m);
						} else if (this._side == 'front' || this._side == 'top') {
							cs += slide;
							cs = Math.min(Math.max(cs, 0), max.c);
						}
					}
					else if (axis == 'y') {
						if (this._side == 'right' || this._side == 'front') {
							ts += slide;
							ts = Math.min(Math.max(ts, 0), max.t);
						} else if (this._side == 'top') {
							ms += slide;
							ms = Math.min(Math.max(ms, 0), max.m);
						}
					}
					else {
						// axis == 'z'
						if (this._side == 'front') {
							ms += slide;
							ms = Math.min(Math.max(ms, 0), max.m);
						} else if (this._side == 'right') {
							cs += slide;
							cs = Math.min(Math.max(cs, 0), max.c);
						} else if (this._side == 'top') {
							ts += slide;
							ts = Math.min(Math.max(ts, 0), max.t);
						}
					}

					this._slide.t = ts;
					this._slide.m = ms;
					this._slide.c = cs;

					this.update();
				}
				snap(){
					if (this.rotation.X < -45) {
						// Top
						this.side="top";
					}
					else if (this.rotation.X >45) {
						// Bottom

					}
					else {
						// Default
						if (this.rotation.Y >= -45 && this.rotation.Y <= 45) {
							//Front
							this.side="front";
						} else if (this.rotation.Y <-45) {
							//Right
							this.side="right";
						} else if (this.rotation.Y > 45) {
							//Left
							this.side="left";
						} else {
							//Back

						}
					}
				}
				selectPayment(paymentCell) {
					paymentCell = $(paymentCell);
					const c = paymentCell.attr("cube-cash");
					const t = paymentCell.attr("cube-term");
					const m = paymentCell.attr("cube-mileage");
					const pmt = paymentCell.find("input").val();
					this.selectedPayment = {c: c, t: t, m: m};
					$(".payments .selectedPayment").removeClass("selectedPayment");
					var cell = pane.getPaymentCell(c, t, m)
					cell.addClass("selectedPayment");
					cell.find("input").addClass("selectedPayment");
					this.$(".selected-payment-display").text("Cash Down: " + cashDownValues[c] + ", Term: " + termValues[t] + ", Mileage: " + mileageValues[m] + ", Payment: $" + pmt);
				}
				update() {
					var ts=this._slide.t, ms=this._slide.m, cs=this._slide.c;
					var max = this.cube.getCubeSize(-3);
					var x=cs, y=ts, z=parseInt($(".cube").attr("z"));
					this.viewState = this.viewStates.AllShown;
					this.viewState = this.viewStates.Custom;
					if (this._side == 'right') {
						x=Math.min(ms, max.m);
						x -= (this.size.m - this.size.c)/2 + 1;
						y=Math.min(ts, max.t);
						z=this.size.c;

						var effectiveCS=max.c+2 - cs;
						z = (cs-0.5) * this.scale;
						for (let i = 0; i < effectiveCS; i++) {
							$("div.c" + (max.c+3-i)).hide();
						}

						this.cube.hideCells("right", cs);
						this.$(".depth-value .value").text(cashDownValues[cs]);
						this.updateRatesDisplay(false);
					}
					else if (this._side == 'top') {
						x=Math.min(cs, max.c);
						y=-this.size.m+3+this._slide.m;
						y+=this.offset.m-1.5;
						z = (1.5-ts) * 100;
						this.cube.hideCells("top", ts);
						this.$(".depth-value .value").text(termValues[ts]);
						this.updateRatesDisplay(true, ts);
					}
					else {
						x=Math.min(cs, max.c);
						y=Math.min(ts, max.t);
						z = (this.offset.m - ms) * this.scale;

						this.cube.hideCells("front", ms);
						this.$(".depth-value .value").text(mileageValues[ms]);
						this.updateRatesDisplay(false);
					}
					this.updateGridX();
					this.updateGridY();
					this.cube.update(x, y, z, this.snapRotation.X, this.snapRotation.Y);
					this.updateLocators();
				}
				updateGridY(){
					switch (this._side) {
						case "top":
							this.$(".grid-y div:visible").css("transform", "translateY(" + ((this._slide.m*-this.scale) + "px)"));
							break;
						default:
							this.$(".grid-y div:visible").css("transform", "translateY(" + ((this._slide.t*-this.scale) + "px)"));
							break;
					}
				}
				updateGridX(){
					switch (this._side) {
						case "right":
							this.$(".grid-x .pmt-mileage").css("left", ((this._slide.m*-this.scale) + "px"));
							break;
						default:
							this.$(".grid-x .pmt-cashdown").css("left", ((this._slide.c*-this.scale) + "px"));
							break;
					}
				}
				updateLocators(side, cs, ts, ms) {
					$(".locator").removeClass("active");
					var indexX=0, indexY=0, indexZ=0;
					var hLocators = $("#horizontal-locator").find(".locator");
					var vLocators = $("#vertical-locator").find(".locator");
					var dLocators = this.$(".depth-locator .locator");

					switch (this.side) {
						case 'front':
							indexX = this._slide.c;
							indexY = this._slide.t;
							indexZ = (dLocators.length - 1) - this._slide.m;
							break;
						case 'right':
							indexX = this._slide.m;
							indexY = this._slide.t;
							indexZ = this._slide.c;
							break;
						case 'top':
							indexX = this._slide.c;
							indexY = this._slide.m;
							indexZ = (dLocators.length - 1) - this._slide.t;
							break;
					}
					for (let i = 0; i < 3; i++) {
						$(hLocators[indexX + i]).addClass("active");
						$(vLocators[indexY + i]).addClass("active");
					}
					$(dLocators[indexZ]).addClass("active");
				}
				updateRatesDisplay(isTop, index) {
					if (isTop == true) {
						this.$(".pmt-rate input").val(rateValues[index]);
					} else {
						for (let i = 0; i < rateValues.length; i++) {
							$(this.$(".pmt-rate input")[i]).val(rateValues[i]);
						}
					}
				}
				get viewState() {
					return this._viewState;
				}
				set viewState(val) {
					if (val != this._viewState) {
						switch (val) {
							case this.viewStates.FreeRotation:
								this.$(".payments td").show();
								this.$(".cube>div").hide();
								this.$(".cube>div.front.m1").show();
								this.$(".cube>div.top.t1").show();
								this.$(".cube>div.right.c" + this.size.c).show();
								this.$(".cube>div.left.c1").show();
								this.$(".cube>div.bottom.t" + this.size.t).show();
								this.$(".cube").addClass("free-rotation");
								this._viewState = this.viewStates.FreeRotation;
								break;
							case this.viewStates.AllShown:
								this.$(".payments td").show();
								this.$(".cube>div").show();
								this._viewState = this.viewStates.AllShown;
								this.$(".cube").removeClass("free-rotation");
								break;
							default:
								this._viewState = this.viewStates.Custom;
								this.$(".cube").removeClass("free-rotation");
								break;
						}
					}
				}
				zoom(inOut) {
					inOut = inOut || 'in';
					var axisClass = "." + this.side;
					const zIn = axisClass==".right"? -1:1;
					const zOut = axisClass==".right"? 1:-1;
					if (inOut == "in") {
						var target = $(axisClass + ':visible').first();
						this.slide('z', zIn);
					} else if (inOut == "out") {
						var target = $(axisClass + ':visible').first().prev();
						target.fadeIn(250);
						this.slide('z', zOut);
					}
				}
			}
		</script>
		<script>
			var cashDownValues = [
				0,
				1000,
				2000,
				3000,
				4000,
				5000,
				6000,
				7000
			]
			var termValues = [
				24,
				36,
				48,
				60,
				72,
				84,
				96,
				108,
				120
			]
			var mileageValues = [
				7500,
				10000,
				12000,
				15000,
				17000,
				20000,
				22000
			]
			var rateValues = [
				0.0031,
				0.0032,
				0.0033,
				0.0034,
				0.0035,
				0.0036,
				0.0037,
				0.0038,
				0.0039
			]

			var pane;

			function fixPaymentLocation() {
				var viewportWidth = Math.round($(window).width()/2)+"px";
				var viewportHeight = Math.round($(window).height()/2)+"px";
				$("#payments").css("left", viewportWidth);
				$("#payments").css("top", viewportHeight);
			}

			$(document).ready(function() {
				createPaymentCube(5, 6, 4);
			})

			function createPaymentCube(x, y, z) {
				pane = new PaymentCubePane($("#payments"), x, y, z);
				pane.side="front";

				var payments = getPayments(pane);
				pane.populateHeaders();
				pane.populatePayments(payments);
			}

			function getPayments(pane) {
				var x=pane.size.c, y=pane.size.t, z=pane.size.m;
				var pmts = [];
				for (let d = 0; d < z; d++) {
					const pmtZ = [];
					pmts.push(pmtZ);
					for (let h = 0; h < y; h++) {
						const pmtY = [];
						pmtZ.push(pmtY);
						for (let w = 0; w < x; w++) {
							let amt = w + (h * x) + (d * x * y) + 1;
							pmtY.push(amt);
						}
					}
				}
				return pmts;
			}
			function rotateCube(){
				var x = parseInt($("#RotationX").val());
				var y = parseInt($("#RotationY").val());
				var z = parseInt($("#TranslationZ").val()) * 50;
				pane.freeRotation(x, y, z);
			}
		</script>
		<script>
			var mouseDown = 0;

			function trackball(evt) {
				if (mouseDown) {
					const tb = $('#trackball');
					const offset = tb.offset();
					// var y = Math.round((((evt.pageX - offset.left)/1.5)-50)*180)/100;
					// var x = Math.round((((evt.pageY - offset.top)/1.5)-50)*-180)/100;
					var y = (((evt.pageX - offset.left)/1.5)-50)*1.80;
					var x = (((evt.pageY - offset.top)/1.5)-50)*-1.80;
					tb.text("x:" + Math.round(x) + "deg | y:" + Math.round(y) + "deg");

					$("#RotationX").val(x);
					$("#RotationY").val(y);
					pane.freeRotation(x, y);
				}
			}

			$(document).ready(function(){
				document.body.onmousedown = function() {
					mouseDown=true;
				}
				document.body.onmouseup = function() {
					mouseDown=false;

					// // This is not implemeted as John requested, but may be more user friendly.
					// pane.snap();
				}
				$("#trackball").on("mousemove", trackball);
				$(window).resize(fixPaymentLocation);
			})
		</script>
		<style>
			.new-school #trackball {
				width:150px;
				height:150px;
				background:#C41F26;
				user-select: none;
				cursor:move;
				border:5px double #ABACA5;
				line-height:150px;
				text-align:center;
				color:white;
			}
			#trackball {
				width:150px;
				height:150px;
				background:#e0e0e0;
				user-select: none;
				cursor:move;
				border:5px double darkcyan;
				line-height:150px;
				text-align:center;
			}
		</style>
	</head>

	<body>
		<!--
			Notes:

			Should be able to pan up or down current face of cube. - John H.
			Selected payment should be retained when panning, rotating, or zooming, even if not shown in new view. - John H.
			Should have a button to restore grid to default view. - John H.
			Should have a button to quickly travel to selected payment from current location. - John H.
			Next header option should be shown as gray off to the right of the currently active header option. - John H.

			Should display selected payment information/coordinates in the empty cell at the top left. - Eric H.



			10/31/2019 notes from John:

			Should have fluid, free rotation of the cube, with a button to snap to the nearest side. The control for this may look something like a track ball.
			Depth indicator could take notes from non-maximized window stacking in Windows. For illustration of this, open Microsoft Word multiple times.

		-->
		<div id="payments"></div>

		<div id="debugtools" style="width:10vw; min-height:30vh; position:absolute; left:10vw; top:50%;padding:1vw; transform:translate(0, -50%);">
			<h3>Debug Tools</h3>
			X Rotation: <input type="range" min="-180" max="180" value="0" step="10" class="slider" id="RotationX" onchange="rotateCube();" /><br/>
			<br/>
			<br/>
			Y Rotation: <input type="range" min="-90" max="180" value="0" step="10" class="slider" id="RotationY" onchange="rotateCube();" />
			<br/>
			<br/>
			Z Translation: <input type="range" min="-20" max="15" value="3" class="slider" id="TranslationZ" onchange="rotateCube();" />
			<br/>
			<br/>
			<div id="trackball"></div>
			<button onclick="pane.snap();">Snap to Closest</button>
			<button onclick="$('body').toggleClass('new-school');">Toggle new style</button>
		</div>
	</body>

</html>